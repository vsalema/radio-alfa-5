<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Flame FM ‚Äì Web Radio</title>
  <style>
  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;
    background: linear-gradient(to bottom, rgba(93, 188, 218, 1) 0%, rgba(72, 140, 169, 1) 100%);
    background-repeat: repeat;
    color: #fff;
  }

  /* ---- WRAPPER RESPONSIVE ---- */
  .radio-wrapper {
    width: 100%;
    max-width: 900px;
    aspect-ratio: 16 / 9;
    position: relative;
  }

  /* Sur les tr√®s petits √©crans : ne pas forcer le 16/9 (sinon √ßa √©crase tout) */
  @media (max-width: 600px) {
    .radio-wrapper {
      aspect-ratio: auto;
    }
  }

  .radio-shell {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 26px;
    background:
      radial-gradient(circle at 20% 15%, rgba(255,255,255,0.3) 0, transparent 45%),
      radial-gradient(circle at 80% 15%, rgba(255,255,255,0.28) 0, transparent 45%),
      linear-gradient(135deg, #ff6a00, #ff3d00 45%, #b02000 100%);
    box-shadow:
      0 28px 60px rgba(0,0,0,0.8),
      inset 0 0 0 3px rgba(0,0,0,0.6);
    padding: 18px 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background-image: url("https://t4.ftcdn.net/jpg/05/10/48/51/240_F_510485158_vyozgwyVPi2SUP246x2CIXyQOCNvyvtp.jpg");
    background-repeat: no-repeat;
    background-size: 178%;
  }

  .radio-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .brand {
    font-weight: 800;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    font-size: 0.9rem;
    color: #ffe0b2;
    text-shadow: 0 2px 4px rgba(0,0,0,0.7);
    white-space: nowrap;
  }

  .freq-window {
    flex: 1;
    min-width: 180px;
    margin: 0 1rem;
    padding: 8px 14px;
    border-radius: 999px;
    background: linear-gradient(to bottom, #262626, #050505);
    border: 1px solid rgba(255,255,255,0.18);
    box-shadow:
      inset 0 0 12px rgba(0,0,0,0.9),
      0 2px 5px rgba(0,0,0,0.7);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  .freq-scale {
    flex: 1;
    font-size: 0.75rem;
    color: #e0e0e0;
    opacity: 0.9;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .freq-row {
    display: flex;
    justify-content: space-between;
    font-variant-numeric: tabular-nums;
  }

  .freq-current {
    font-size: 1.4rem;
    font-weight: 700;
    color: #ffcc80;
    text-shadow: 0 2px 6px rgba(0,0,0,0.9);
    margin-left: 12px;
  }

  .status-led {
    width: 11px;
    height: 11px;
    border-radius: 50%;
    background: #ff5252;
    box-shadow: 0 0 12px rgba(255,82,82,0.9);
    margin-left: 10px;
  }

  .radio-mode {
    font-size: 0.75rem;
    text-align: right;
    opacity: 0.9;
    white-space: nowrap;
  }

  /* ---- CENTRE ---- */
  .radio-center {
    flex: 1;
    display: grid;
    grid-template-columns: 1.1fr 0.9fr;
    gap: 18px;
    min-height: 0;
  }

  .center-left {
    border-radius: 18px;
    padding: 14px 18px;
    background: radial-gradient(circle at center, rgba(0,0,0,0.75) 0, rgba(0,0,0,0.9) 60%), repeating-linear-gradient(60deg, rgba(255,255,255,0.04) 0, rgba(255,255,255,0.04) 2px, transparent 2px, transparent 6px);
    box-shadow: inset 0 0 22px rgba(0,0,0,0.9), 0 4px 10px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
    background-image: url("https://raw.githubusercontent.com/imagesloads/images/refs/heads/main/img_51c96f7945128b7f.gif");
    background-size: cover;
    background-position: center;
  }

  .glass-screen {
    position: absolute;
    inset: 0;
    border-radius: 16px;
    background:
      linear-gradient(
        135deg,
        rgba(255,255,255,0.18) 0%,
        rgba(255,255,255,0.02) 40%,
        rgba(255,255,255,0.08) 60%,
        rgba(255,255,255,0.01) 100%
      ),
      rgba(255,255,255,0.03);
    backdrop-filter: blur(3px) brightness(1.08);
    -webkit-backdrop-filter: blur(3px) brightness(1.08);
    border: 1.8px solid rgba(255, 255, 255, 0.42);
    box-shadow:
      inset 0 0 8px rgba(255,255,255,0.20),
      inset 0 0 22px rgba(0,0,0,0.35),
      0 3px 12px rgba(0,0,0,0.45),
      0 -2px 6px rgba(255,255,255,0.25);
    opacity: 0.28;
    z-index: 4;
    pointer-events: none;
  }

  /* Canvas visualizer */
 #visualizer {
  position: absolute;
  inset: 10px;
  width: calc(100% - 20px);
  height: calc(100% - 20px);
  z-index: 0;
  opacity: 0.9;
  pointer-events: none;
}

  .station-logo {
    position: absolute;
    left: 50%;
    top: 45%;
    transform: translate(-50%, -50%);
    width: 60%;
    max-width: 260px;
    aspect-ratio: 1 / 1;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    opacity: 0.9;
    filter: drop-shadow(0 6px 14px rgba(0,0,0,0.8));
    pointer-events: none;
    z-index: 0;
  }

  .station-title {
    position: relative;
    z-index: 1;
    font-size: 1.7rem;
    font-weight: 800;
    text-align: center;
    text-shadow: 0 3px 8px rgba(0,0,0,0.9);
  }

  .station-meta {
    position: relative;
    z-index: 1;
    font-size: 0.9rem;
    opacity: 0.9;
    text-align: center;
  }

  .center-right {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 12px;
    border-radius: 18px;
    padding: 14px 16px;
    background: linear-gradient(to right bottom, rgba(0,0,0,0.92), rgba(0,0,0,0.85));
    box-shadow: inset 0 0 18px rgba(0,0,0,0.9), 0 4px 10px rgba(0,0,0,0.7);
    background-image: url("https://raw.githubusercontent.com/imagesloads/images/refs/heads/main/img_77b216aa145f61ee.jpg");
    background-size: cover;
    background-position: center;
  }

  .controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }

  button, select, input {
    border-radius: 999px;
    border: none;
    padding: 8px 14px;
    font-size: 0.9rem;
    outline: none;
  }

  button {
    cursor: pointer;
    background: rgba(255,255,255,0.10);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    backdrop-filter: blur(4px);
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
  }

  button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    background: rgba(255,255,255,0.18);
  }

  button:active {
    transform: translateY(0);
    box-shadow: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, #ff9800, #ff5722);
    border: none;
    box-shadow: 0 6px 14px rgba(0,0,0,0.6);
    font-weight: 600;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #ffb74d, #ff7043);
  }

  .station-select {
    min-width: 210px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.24);
  }

  .volume-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.8rem;
    opacity: 0.85;
  }

  .volume-row input[type="range"] {
    flex: 1;
  }

  .radio-bottom {
    border-radius: 18px;
    padding: 10px 14px;
    background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.75));
    box-shadow: inset 0 0 12px rgba(0,0,0,0.9), 0 3px 8px rgba(0,0,0,0.7);
    font-size: 0.78rem;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background-image: url("https://raw.githubusercontent.com/imagesloads/images/refs/heads/main/img_5da40780414dc252.jpg");
    background-repeat: no-repeat;
    background-size: 100%;
    background-position-x: -2px;
    background-position-y: -185px;
  }

  .add-form {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .add-form input {
    background: rgba(0,0,0,0.65);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    min-width: 145px;
  }

  .hint {
    opacity: 0.75;
  }

  /* ---- NAV STATIONS ---- */
  .station-row {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 14px;
  }

  .nav-btn {
    padding: 10px 16px;
    font-size: 0.95rem;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    backdrop-filter: blur(4px);
    transition: 0.2s ease;
    white-space: nowrap;
  }

  .nav-btn:hover {
    background: rgba(255,255,255,0.18);
  }

  .station-select {
    width: 100%;
    min-width: 180px;
    text-align: center;
  }

  /* ---- BREAKPOINTS ---- */

  /* Tablettes / petits laptops */
  @media (max-width: 780px) {
    .radio-shell {
      padding: 14px;
    }
    .radio-center {
      grid-template-columns: 1fr;
    }
    .station-title {
      font-size: 1.3rem;
    }
    .brand {
      font-size: 0.8rem;
      letter-spacing: 0.14em;
    }
    .freq-current {
      font-size: 1.2rem;
    }
  }

  /* Mobiles */
  @media (max-width: 560px) {
    body {
      align-items: stretch;
    }

    .radio-shell {
      padding: 12px;
      border-radius: 18px;
    }

    .radio-top {
      flex-direction: column;
      align-items: stretch;
    }

    .freq-window {
      margin: 0;
    }

    .station-row {
      grid-template-columns: auto 1fr auto;
      gap: 8px;
    }

    .nav-btn {
      padding: 8px 10px;
      font-size: 1.1rem;
    }

    .station-select {
      min-width: 0;
      font-size: 0.85rem;
    }

    .center-right {
      padding: 12px;
      gap: 10px;
    }

    .radio-bottom {
      font-size: 0.74rem;
    }
  }

  /* Tr√®s petits √©crans */
  @media (max-width: 430px) {
    .station-title {
      font-size: 1.1rem;
    }
    .station-meta {
      font-size: 0.8rem;
    }
    .brand {
      font-size: 0.7rem;
    }
    .radio-mode {
      font-size: 0.65rem;
    }
  }
/* Ligne skin */
.skin-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 4px;
  font-size: 0.8rem;
}

.skin-row span {
  opacity: 0.8;
}

.skin-select {
  flex: 1;
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 0.8rem;
  background: rgba(0,0,0,0.7);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.25);
}

/* SKINS */
/* Skin par d√©faut : rien √† faire, c'est ton style actuel */
.radio-shell[data-skin="default"] {
  /* on garde ton background existant */
}

/* M√©tal bross√© */
.radio-shell[data-skin="metal"] {
  background-image:
    radial-gradient(circle at 20% 15%, rgba(255,255,255,0.25) 0, transparent 45%),
    radial-gradient(circle at 80% 15%, rgba(255,255,255,0.18) 0, transparent 45%),
    repeating-linear-gradient(
      135deg,
      #5f6a72 0px,
      #5f6a72 2px,
      #343b40 2px,
      #343b40 4px
    );
  background-size: auto;
}

/* Bois vintage */
.radio-shell[data-skin="wood"] {
  background-image:
    radial-gradient(circle at 15% 10%, rgba(255,255,255,0.18) 0, transparent 40%),
    radial-gradient(circle at 85% 12%, rgba(255,255,255,0.15) 0, transparent 40%),
    linear-gradient(
      135deg,
      #4e2a12 0%,
      #7b4a1f 30%,
      #a5642c 60%,
      #4e2a12 100%
    );
}

/* Verre fum√© / n√©on */
.radio-shell[data-skin="glass"] {
  background-image:
    radial-gradient(circle at 20% 15%, rgba(255,255,255,0.28) 0, transparent 45%),
    radial-gradient(circle at 80% 20%, rgba(0,255,255,0.22) 0, transparent 50%),
    linear-gradient(135deg, #22272f 0%, #15181d 50%, #101318 100%);
  box-shadow:
    0 28px 60px rgba(0,0,0,0.9),
    inset 0 0 0 1px rgba(255,255,255,0.08),
    inset 0 0 26px rgba(0,255,255,0.2);
}

  .freq-window {
  position: relative; /* d√©j√† l√†, mais au cas o√π */
}

/* Aiguille FM old school */
.freq-needle {
  position: absolute;
  bottom: 4px;
  top: 4px;
  width: 2px;
  background: linear-gradient(to top, #ffab40, #fff3e0);
  box-shadow: 0 0 6px rgba(0,0,0,0.8);
  transform: translateX(-50%);
  left: 0%;
  transition: left 0.35s cubic-bezier(0.23, 1, 0.32, 1);
}

  </style>

</head>
<body>
<div class="radio-wrapper">
  <div class="radio-shell">
    <!-- Haut -->
    <div class="radio-top">
      <div class="brand">FLAME&nbsp;FM</div>

      <div class="freq-window">
  <div class="freq-scale">
    <div class="freq-row">
      <span>FM</span>
      <span>88</span><span>92</span><span>96</span><span>100</span><span>104</span><span>108</span>
    </div>
    <div class="freq-row" style="opacity:0.7;">
      <span>MHz</span>
      <span>‚óè</span><span>‚óè</span><span>‚óè</span><span>‚óè</span><span>‚óè</span><span>‚óè</span>
    </div>
  </div>

  <!-- Aiguille FM -->
  <div class="freq-needle" id="freqNeedle"></div>

  <div class="freq-current" id="freqMain">00.0</div>
  <div class="status-led" id="statusLed"></div>
</div>


      <div class="radio-mode">FM ¬∑ WEB STREAM</div>
    </div>

    <!-- Centre -->
    <div class="radio-center">
      <div class="center-left">
        <!-- Visualizer derri√®re le logo -->
        <div id="visualizer"></div>
        <div class="glass-screen"></div>
        <div class="station-logo" id="stationLogo"></div>

        <div class="station-title" id="stationName">S√©lectionne une station</div>
        <div class="station-meta" id="stationMeta">‚Äî</div>
      </div>

      <div class="center-right">
        <div class="controls-row station-row">
  <button id="prevBtn" class="nav-btn" data-full="‚èÆ Pr√©c√©dente">‚èÆ</button>

  <select id="stationSelect" class="station-select"></select>

  <button id="nextBtn" class="nav-btn" data-full="Suivante ‚è≠">‚è≠</button>
</div>
        <div class="controls-row">
          <button id="playPauseBtn" class="btn-primary">‚ñ∂Ô∏è Lecture</button>
          <button id="stopBtn">‚èπ Stop</button>
        </div>
        <div class="controls-row">
  <select id="visualModeSelect" class="station-select">
    <option value="dj">üéö DJ Bars</option>
    <option value="led">üí° Classic LEDs</option>
    <option value="waves">üåä Waves</option>
    <option value="aurora">üåå Aurora</option>
  </select>
</div>

        <div class="volume-row">
          <span>Volume</span>
          <input type="range" min="0" max="1" step="0.01" id="volumeSlider" />
        </div>
      </div>
    </div>

    <!-- Bas -->
    <div class="radio-bottom">
      <div class="hint">
        üí° Tu peux brancher tes propres radios : indique simplement nom, fr√©quence et URL de flux audio.
      </div>
      <form class="add-form" id="addForm">
        <input type="text" id="newName" placeholder="Nom de la station" required />
        <input type="text" id="newFreq" placeholder="Fr√©quence (ex : 92.3)" required />
        <input type="text" id="newUrl" placeholder="URL du flux audio" required />
        <button type="submit">‚ûï Ajouter</button>
      </form>
    <div class="skin-row">
  <span>Skin</span>
  <select id="skinSelect" class="skin-select">
    <option value="default">Flame</option>
    <option value="metal">M√©tal bross√©</option>
    <option value="wood">Vintage bois</option>
    <option value="glass">Verre fum√©</option>
  </select>
</div>

    
    </div>
  </div>
</div>

<!-- Player audio central -->
<audio id="audioPlayer" crossorigin="anonymous"></audio>

<script>
  // --- Stations (tu peux en ajouter autant que tu veux) ---
  const stations = [
    {
      name: "Radio Alfa",
      freq: 98.6,
      url: "https://n16a-eu.rcs.revma.com/amrbkhqtkm0uv?rj-ttl=5&rj-tok=AAABjyZZV10A8pNBeIWHkkzM-w",
      city: "Paris",
      desc: "Communaut√© lusophone",
      logo: "https://radioalfa.net/wp-content/uploads/2023/02/logo-radio-alfa-DAB-avril-2021-294x300.png"
    },
    {
      name: "Radio Comercial",
      freq: 97.7,
      url: "https://stream-icy.bauermedia.pt/comercial.mp3",
      city: "Lisboa",
      desc: "Hits & talk",
      logo: "https://www.zupimages.net/up/24/18/ywnd.png"
    },
    {
      name: "M80",
      freq: 104.7,
      url: "https://stream-icy.bauermedia.pt/m80.aac",
      city: "Portugal",
      desc: "80s / Classics",
      logo: "https://upload.wikimedia.org/wikipedia/commons/0/02/M80_Portugal.svg"
    }
  ];
  const visualModeSelect = document.getElementById("visualModeSelect");
  const freqNeedle = document.getElementById("freqNeedle");
  const audio = document.getElementById("audioPlayer");
  const stationSelect = document.getElementById("stationSelect");
  const stationName = document.getElementById("stationName");
  const stationMeta = document.getElementById("stationMeta");
  const freqMain = document.getElementById("freqMain");
  const statusLed = document.getElementById("statusLed");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const stopBtn = document.getElementById("stopBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const addForm = document.getElementById("addForm");
  const newName = document.getElementById("newName");
  const newFreq = document.getElementById("newFreq");
  const newUrl = document.getElementById("newUrl");
  const volumeSlider = document.getElementById("volumeSlider");
const radioShell = document.querySelector(".radio-shell");
const skinSelect = document.getElementById("skinSelect");

  let currentIndex = -1;
  let isPlaying = false;

  let timeArray = null;
  let visualMode = "dj"; // mode par d√©faut


  audio.volume = 0.7;
  volumeSlider.value = audio.volume;

  // --- Visualizer ---
  let audioCtx = null;
  let analyser = null;
  let dataArray = null;
  let sourceNode = null;
  let animationId = null;
  const canvas = document.getElementById("visualizerCanvas");
  let ctx = null;
  if (canvas && canvas.getContext) {
    ctx = canvas.getContext("2d");
  }

  function updateNeedle(freq) {
  if (!freqNeedle) return;

  // plage FM simul√©e : 88 √† 108 MHz
  const minF = 88;
  const maxF = 108;
  const clamped = Math.max(minF, Math.min(maxF, freq));
  const percent = ((clamped - minF) / (maxF - minF)) * 100;

  freqNeedle.style.left = percent + "%";
}

  
  
  function refreshStationOptions() {
    stationSelect.innerHTML = "";
    stations.sort((a, b) => {
  if (a.name === "Radio Alfa") return -1;   // Alfa toujours en 1er
  if (b.name === "Radio Alfa") return 1;
  return a.freq - b.freq;                   // les autres restent tri√©es par fr√©quence
});
    stations.forEach((st, index) => {
      const opt = document.createElement("option");
      opt.value = index;
      opt.textContent = `${st.freq.toFixed(1)} MHz ‚Äì ${st.name}`;
      stationSelect.appendChild(opt);
    });

    if (stations.length > 0) {
      currentIndex = 0;
      stationSelect.value = 0;
      updateUIForStation();
    } else {
      currentIndex = -1;
      updateUIForNoStation();
    }
  }

  function updateUIForNoStation() {
    stationName.textContent = "Aucune station configur√©e";
    stationMeta.textContent = "Ajoute une station en bas du poste.";
    freqMain.textContent = "00.0";
    updateNeedle(88);
    const logoEl = document.getElementById("stationLogo");
    logoEl.style.backgroundImage = "none";
    logoEl.style.opacity = "0";
    statusLed.style.background = "#555";
    statusLed.style.boxShadow = "none";
    playPauseBtn.textContent = "‚ñ∂Ô∏è Lecture";
    isPlaying = false;
    stopVisualizer();
  }

  function updateUIForStation() {
    if (currentIndex < 0 || currentIndex >= stations.length) {
      updateUIForNoStation();
      return;
    }

    const st = stations[currentIndex];
    stationName.textContent = st.name;
    stationMeta.textContent =
  `${st.freq.toFixed(1)} MHz ¬∑ ${st.city} ¬∑ ${st.desc || ""}`;
freqMain.textContent = st.freq.toFixed(1);
updateNeedle(st.freq);
 // aiguille au d√©but de la bande


    const logoEl = document.getElementById("stationLogo");
    if (st.logo) {
      logoEl.style.backgroundImage = `url(${st.logo})`;
      logoEl.style.opacity = "0.9";
    } else {
      logoEl.style.backgroundImage = "none";
      logoEl.style.opacity = "0";
    }
  }

  function setStatusPlaying(playing) {
    isPlaying = playing;
    if (playing) {
      statusLed.style.background = "#4caf50";
      statusLed.style.boxShadow = "0 0 12px rgba(76,175,80,0.95)";
      playPauseBtn.textContent = "‚è∏ Pause";
    } else {
      statusLed.style.background = "#ff5252";
      statusLed.style.boxShadow = "0 0 12px rgba(255,82,82,0.95)";
      playPauseBtn.textContent = "‚ñ∂Ô∏è Lecture";
    }
  }

  function loadCurrentStation(autoPlay = true) {
    if (currentIndex < 0 || currentIndex >= stations.length) return;
    const st = stations[currentIndex];
    audio.src = st.url;
    updateUIForStation();
    if (autoPlay) {
      audio.play().then(() => {
        setStatusPlaying(true);
        startVisualizer();
      }).catch((err) => {
        console.warn("Lecture impossible :", err);
        setStatusPlaying(false);
        stopVisualizer();
      });
    }
  }

  function initVisualizer() {
    if (!ctx || !canvas) return;
    if (audioCtx && analyser && sourceNode) return;

    try {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (!sourceNode) {
        sourceNode = audioCtx.createMediaElementSource(audio);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
timeArray = new Uint8Array(analyser.fftSize);       
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
      }
    } catch (e) {
      console.warn("Visualizer d√©sactiv√© (Web Audio non disponible ou d√©j√† attach√©) :", e);
      audioCtx = null;
      analyser = null;
      dataArray = null;
      sourceNode = null;
    }
  }

  function resizeCanvas() {
    if (!canvas || !ctx) return;
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

function drawVisualizer() {
  if (!analyser || !ctx || !canvas) return;

  resizeCanvas();

  const dpr = window.devicePixelRatio || 1;
  const width  = canvas.width  / dpr;
  const height = canvas.height / dpr;

  // L√©g√®re persistance de fond
  ctx.save();
  ctx.globalAlpha = 0.28;
  ctx.fillStyle = "rgba(0, 0, 0, 1)";
  ctx.fillRect(0, 0, width, height);
  ctx.restore();

  // ----- MODE DJ BARS (ton visuel actuel) -----
  if (visualMode === "dj") {
    analyser.getByteFrequencyData(dataArray);

    const barCount = 48;
    const step = Math.floor(dataArray.length / barCount);
    const barWidth = width / barCount;
    const centerY = height * 0.55;

    ctx.save();
    ctx.shadowBlur = 16;
    ctx.shadowColor = "#00e5ff";

    for (let i = 0; i < barCount; i++) {
      const value = dataArray[i * step] || 0;
      const amp = value / 255;

      const barHeight = amp * height * 0.45;
      const x = i * barWidth + barWidth * 0.2;

      const hue = (i * 9 + value / 2) % 360;
      ctx.fillStyle = `hsl(${hue}, 100%, 55%)`;

      const topY = centerY - barHeight;
      ctx.fillRect(x, topY, barWidth * 0.6, barHeight);

      const bottomHeight = barHeight * 0.6;
      ctx.fillRect(x, centerY, barWidth * 0.6, bottomHeight);
    }

    ctx.restore();

    // Laser horizontal
    ctx.save();
    ctx.strokeStyle = "rgba(0, 255, 255, 0.55)";
    ctx.lineWidth = 2;
    ctx.shadowBlur = 10;
    ctx.shadowColor = "rgba(0, 255, 255, 0.9)";
    ctx.beginPath();
    ctx.moveTo(0, height * 0.55);
    ctx.lineTo(width, height * 0.55);
    ctx.stroke();
    ctx.restore();
  }

  // ----- MODE CLASSIC LED (80 bandes, blocs LED) -----
  else if (visualMode === "led") {
    analyser.getByteFrequencyData(dataArray);

    const barCount  = 80;
    const barSpace  = 0.5;
    const step      = Math.max(1, Math.floor(dataArray.length / barCount));

    const fullBarMaxHeight = height * 0.38;
    const centerY          = height * 0.5;

    const bandWidth = width / barCount;

    ctx.save();
    ctx.shadowBlur  = 14;
    ctx.shadowColor = "rgba(0, 255, 150, 0.9)";

    const segmentCount  = 16;
    const segmentGap    = 2;
    const segmentHeight = (fullBarMaxHeight - (segmentCount - 1) * segmentGap) / segmentCount;

    for (let i = 0; i < barCount; i++) {
      const value = dataArray[i * step] || 0;
      const level = value / 255;
      const filledSegments = Math.floor(level * segmentCount);

      const totalSpace = bandWidth * barSpace;
      const barWidth   = bandWidth - totalSpace;
      const x          = i * bandWidth + totalSpace / 2;

      const gradTop = ctx.createLinearGradient(x, centerY - fullBarMaxHeight, x, centerY);
      gradTop.addColorStop(0, "rgba(180, 255, 220, 1)");
      gradTop.addColorStop(0.5, "rgba(0, 255, 150, 1)");
      gradTop.addColorStop(1, "rgba(0, 90, 40, 1)");

      const gradBottom = ctx.createLinearGradient(x, centerY, x, centerY + fullBarMaxHeight);
      gradBottom.addColorStop(0, "rgba(0, 70, 30, 1)");
      gradBottom.addColorStop(0.5, "rgba(0, 255, 120, 1)");
      gradBottom.addColorStop(1, "rgba(180, 255, 220, 1)");

      for (let s = 0; s < filledSegments; s++) {
        const yTop = centerY - (s + 1) * (segmentHeight + segmentGap);
        const yBottom = centerY + s * (segmentHeight + segmentGap) + segmentGap;

        const alpha = 0.4 + 0.6 * (s / segmentCount);

        ctx.globalAlpha = alpha;
        ctx.fillStyle = gradTop;
        ctx.fillRect(x, yTop, barWidth, segmentHeight);

        ctx.globalAlpha = alpha * 0.8;
        ctx.fillStyle = gradBottom;
        ctx.fillRect(x, yBottom, barWidth, segmentHeight);
      }
    }

    ctx.restore();
  }

  // ----- MODE WAVES (onde fluide) -----
  else if (visualMode === "waves") {
    if (!timeArray || !analyser) {
      animationId = requestAnimationFrame(drawVisualizer);
      return;
    }

    analyser.getByteTimeDomainData(timeArray);

    ctx.save();
    ctx.lineWidth = 2.2;
    ctx.strokeStyle = "rgba(180, 220, 255, 0.95)";
    ctx.shadowBlur = 12;
    ctx.shadowColor = "rgba(120, 180, 255, 1)";
    ctx.beginPath();

    const slice = width / timeArray.length;
    const midY = height * 0.5;

    for (let i = 0; i < timeArray.length; i++) {
      const v = (timeArray[i] - 128) / 128; // -1 √† 1
      const y = midY + v * height * 0.35;
      const x = slice * i;

      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }

    ctx.stroke();
    ctx.restore();
  }

  // ----- MODE AURORA (bandes douces "nordiques") -----
  else if (visualMode === "aurora") {
    analyser.getByteFrequencyData(dataArray);

    const barCount = 60;
    const step = Math.floor(dataArray.length / barCount);
    const barWidth = width / barCount;

    ctx.save();
    const baseY = height * 0.75;

    for (let i = 0; i < barCount; i++) {
      const value = dataArray[i * step] || 0;
      const amp = value / 255;

      const barHeight = amp * height * 0.6;
      const x = i * barWidth;
      const y = baseY - barHeight;

      const grad = ctx.createLinearGradient(x, y, x, baseY);
      grad.addColorStop(0, "rgba(120, 200, 255, 0.05)");
      grad.addColorStop(0.3, "rgba(90, 220, 255, 0.22)");
      grad.addColorStop(0.7, "rgba(120, 255, 200, 0.45)");
      grad.addColorStop(1, "rgba(10, 40, 80, 0.0)");

      ctx.fillStyle = grad;
      ctx.fillRect(x, y, barWidth * 1.1, barHeight);
    }

    ctx.restore();
  }

  animationId = requestAnimationFrame(drawVisualizer);
}



  function startVisualizer() {
    if (!canvas || !ctx) return;
    initVisualizer();
    if (audioCtx && audioCtx.state === "suspended") {
      audioCtx.resume().catch(() => {});
    }
    if (analyser && !animationId) {
      animationId = requestAnimationFrame(drawVisualizer);
    }
  }

  function stopVisualizer() {
    if (animationId) {
      cancelAnimationFrame(animationId);
      animationId = null;
    }
    if (ctx && canvas) {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
    }
  }

  function goToPrevStation() {
    if (stations.length === 0) return;
    currentIndex = (currentIndex - 1 + stations.length) % stations.length;
    stationSelect.value = currentIndex;
    loadCurrentStation(isPlaying);
  }

  function goToNextStation() {
    if (stations.length === 0) return;
    currentIndex = (currentIndex + 1) % stations.length;
    stationSelect.value = currentIndex;
    loadCurrentStation(isPlaying);
  }

  stationSelect.addEventListener("change", () => {
    const idx = parseInt(stationSelect.value, 10);
    if (!isNaN(idx)) {
      currentIndex = idx;
      loadCurrentStation(isPlaying);
    }
  });

  playPauseBtn.addEventListener("click", () => {
    if (!audio.src) {
      loadCurrentStation(true);
      return;
    }
    if (isPlaying) {
      audio.pause();
    } else {
      audio.play().then(() => {
        setStatusPlaying(true);
        startVisualizer();
      }).catch((err) => {
        console.warn("Erreur lecture :", err);
      });
    }
  });

  stopBtn.addEventListener("click", () => {
    if (!audio.src) return;
    audio.pause();
    audio.currentTime = 0;
    setStatusPlaying(false);
    stopVisualizer();
  });

  prevBtn.addEventListener("click", goToPrevStation);
  nextBtn.addEventListener("click", goToNextStation);

  audio.addEventListener("playing", () => {
    setStatusPlaying(true);
    startVisualizer();
  });
  audio.addEventListener("pause", () => {
    setStatusPlaying(false);
    stopVisualizer();
  });
  audio.addEventListener("ended", () => {
    setStatusPlaying(false);
    stopVisualizer();
  });

  volumeSlider.addEventListener("input", () => {
    audio.volume = parseFloat(volumeSlider.value);
  });

  addForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = newName.value.trim();
    const freq = parseFloat(newFreq.value.replace(",", "."));
    const url = newUrl.value.trim();

    if (!name || isNaN(freq) || !url) {
      alert("Merci de remplir tous les champs avec des valeurs valides.");
      return;
    }

    stations.push({
      name,
      freq,
      url,
      city: "Custom",
      desc: "Ajout manuel"
      // logo: "mon-logo.png" // optionnel
    });

    newName.value = "";
    newFreq.value = "";
    newUrl.value = "";

    refreshStationOptions();
    currentIndex = stations.findIndex(
      (s) => s.name === name && s.freq === freq && s.url === url
    );
    stationSelect.value = currentIndex;
    loadCurrentStation(true);
  });

  // ---- Gestion des skins (Flame / M√©tal / Bois / Verre) ----
if (radioShell && skinSelect) {
  // skin par d√©faut
  radioShell.dataset.skin = "default";
  skinSelect.value = "default";

  skinSelect.addEventListener("change", () => {
    const value = skinSelect.value || "default";
    radioShell.dataset.skin = value;
  });
}



  // Init
  refreshStationOptions();
</script>
<script type="module">
  import AudioMotionAnalyzer from "https://cdn.skypack.dev/audiomotion-analyzer?min";

  const audioEl        = document.getElementById("audioPlayer");
  const visualizerEl   = document.getElementById("visualizer");
  const visualModeSelect = document.getElementById("visualModeSelect");

  // Instanciation : DJ Bars = ton th√®me actuel
  const audioMotion = new AudioMotionAnalyzer( visualizerEl, {
    source: audioEl,
    height: 0,              // s‚Äôadapte au conteneur
    width: 0,
    ansiBands: false,
    showScaleX: false,
    bgAlpha: 0,
    overlay: true,
    mode: 6,                // m√™me mode que ton code actuel
    frequencyScale: "log",
    smoothing: 0.7,
    gradient: "classic",
    ledBars: true,
    mirror: 1,
    showPeaks: true
  });

  // --- MAPPAGE DES MODES ---

  function applyVisualMode(mode) {
    switch (mode) {

      // üéö DJ Bars : ton visuel actuel (ne change pas)
      case "dj":
      default:
        audioMotion.setOptions({
          mode: 6,
          gradient: "classic",
          ledBars: true,
          mirror: 1,
          barSpace: 0.2,
          radial: false,
          lineWidth: 0,
          fillAlpha: 0
        });
        break;

      // üí° Classic LEDs ‚Äì 1/8e d‚Äôoctave, barres plus serr√©es
      case "led":
        audioMotion.setOptions({
          mode: 3,             // 1/8e d‚Äôoctave
          gradient: "classic",
          ledBars: true,
          mirror: 1,
          barSpace: 0.5,       // plus d‚Äôespace entre les barres
          radial: false,
          lineWidth: 0,
          fillAlpha: 0
        });
        break;

      // üåä Waves ‚Äì courbe fluide
      case "waves":
        audioMotion.setOptions({
          mode: 10,            // line / area graph
          gradient: "rainbow",
          ledBars: false,
          mirror: 0,
          barSpace: 0,
          lineWidth: 1.5,
          fillAlpha: 0.5,
          radial: false
        });
        break;

      // üåå Aurora ‚Äì mode radial ‚Äúaurore bor√©ale‚Äù
      case "aurora":
        audioMotion.setOptions({
          mode: 10,
          gradient: "prism",
          ledBars: false,
          mirror: 0,
          barSpace: 0,
          lineWidth: 1.5,
          fillAlpha: 0.5,
          radial: true,
          spinSpeed: 0.5,
          reflexRatio: 0.4,
          reflexAlpha: 0.6,
          reflexBright: 1.2,
          reflexFit: true
        });
        break;
    }
  }

  // Initialisation + √©couteur du menu
  if (visualModeSelect) {
    // applique le mode correspondant √† la valeur actuelle du select
    applyVisualMode(visualModeSelect.value || "dj");

    visualModeSelect.addEventListener("change", () => {
      applyVisualMode(visualModeSelect.value || "dj");
    });
  } else {
    // au cas o√π, DJ par d√©faut
    applyVisualMode("dj");
  }
</script>
</body>
</html>
